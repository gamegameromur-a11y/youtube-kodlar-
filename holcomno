from flask import Flask, request, jsonify
import os, json, hashlib, time
from datetime import datetime
from openai import OpenAI

# ================== AYARLAR ==================
MODEL = "gpt-4o-mini"
ADMIN_PASSWORD = "3366"

client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
app = Flask(__name__)

FILES = {
    "users": "users.json",
    "global": "global_knowledge.json",
    "versions": "versions.json"
}

# ================== DOSYA ==================
def load(name, default):
    if not os.path.exists(FILES[name]):
        with open(FILES[name], "w") as f:
            json.dump(default, f)
    with open(FILES[name]) as f:
        return json.load(f)

def save(name, data):
    with open(FILES[name], "w") as f:
        json.dump(data, f, indent=2)

def now():
    return datetime.now().isoformat()

# ================== KULLANICI ==================
def uid(name):
    return hashlib.sha256(name.encode()).hexdigest()

def get_user(name):
    users = load("users", {})
    u = uid(name)

    if u not in users:
        users[u] = {
            "name": name,
            "created": now(),
            "knowledge": []
        }
        save("users", users)

    return users[u], users

# ================== BÄ°LGÄ° TOPLAMA ==================
def collect_knowledge(question, user):
    global_k = load("global", [])
    personal = user["knowledge"]

    all_k = global_k + personal
    result = []

    for k in all_k:
        if any(w.lower() in k["content"].lower() for w in question.split()):
            result.append(k["content"])

    return result[:6]

# ================== ARAYÃœZ ==================
@app.route("/")
def home():
    return """
<!DOCTYPE html>
<html>
<head>
<title>Holcomno</title>
<style>
body{background:#020617;color:#e5e7eb;font-family:Arial;padding:20px}
textarea{width:100%;height:90px}
button{padding:6px;margin-top:5px}
#out{margin-top:15px;white-space:pre-wrap;border:1px solid #334155;padding:10px}
#dev{position:fixed;bottom:15px;right:15px}
</style>
</head>
<body>

<h1>Holcomno ðŸ¦‘</h1>

<script>
let user = localStorage.getItem("hol_user");
if(!user){
  user = prompt("AdÄ±n ne?");
  localStorage.setItem("hol_user", user);
}
</script>

<textarea id="msg"></textarea><br>
<button onclick="send()">GÃ¶nder</button>
<div id="out"></div>

<div id="dev">
<button onclick="teach()">GeliÅŸtir</button>
<button onclick="admin()">Admin</button>
</div>

<script>
function send(){
fetch("/chat",{method:"POST",headers:{"Content-Type":"application/json"},
body:JSON.stringify({user:user,msg:msg.value})})
.then(r=>r.json()).then(d=>out.innerText=d.reply)}
function teach(){
let c=prompt("Holcomno'ya Ã¶ÄŸretilecek bilgi:")
fetch("/teach",{method:"POST",headers:{"Content-Type":"application/json"},
body:JSON.stringify({user:user,content:c})})
.then(r=>r.json()).then(d=>alert(d.status))}
function admin(){
let p=prompt("Åžifre")
let v=prompt("SÃ¼rÃ¼m")
let c=prompt("Global bilgi")
fetch("/admin",{method:"POST",headers:{"Content-Type":"application/json"},
body:JSON.stringify({password:p,version:v,content:c})})
.then(r=>r.json()).then(d=>alert(d.status||d.error))}
</script>

</body>
</html>
"""

# ================== CHAT ==================
@app.route("/chat", methods=["POST"])
def chat():
    data = request.json
    name = data["user"]
    question = data["msg"]

    user, _ = get_user(name)
    knowledge = collect_knowledge(question, user)

    system = f"""
Sen Holcomno'sun.
Uydurma yok.
AÅŸaÄŸÄ±daki eÄŸitim verilerini dikkate al:

{chr(10).join('- '+k for k in knowledge)}
"""

    try:
        r = client.chat.completions.create(
            model=MODEL,
            messages=[
                {"role":"system","content":system},
                {"role":"user","content":question}
            ]
        )
        reply = r.choices[0].message.content
    except:
        reply = "Åžu an API yok ama sorunu aldÄ±m."

    return jsonify({"reply":reply})

# ================== KULLANICI EÄžÄ°TÄ°M ==================
@app.route("/teach", methods=["POST"])
def teach():
    data = request.json
    user, users = get_user(data["user"])

    user["knowledge"].append({
        "content": data["content"],
        "time": now()
    })

    save("users", users)
    return jsonify({"status":"KiÅŸisel eÄŸitim eklendi"})

# ================== ADMIN ==================
@app.route("/admin", methods=["POST"])
def admin():
    data = request.json
    if data["password"] != ADMIN_PASSWORD:
        return jsonify({"error":"Yetkisiz"}),403

    g = load("global", [])
    v = load("versions", [])

    g.append({
        "content": data["content"],
        "version": data["version"],
        "time": now()
    })

    v.append({
        "version": data["version"],
        "time": now()
    })

    save("global", g)
    save("versions", v)

    return jsonify({"status":data["version"]+" yayÄ±nlandÄ±"})

# ================== RUN ==================
app.run(host="0.0.0.0", port=3000)
